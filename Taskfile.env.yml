version: '3'

includes:
  shell:
    taskfile: Taskfile.shell.yml
    internal: true

tasks:

  edit:
    desc: Safely edit env file (SOPS edit - plaintext only in memory!)
    dir: '{{.USER_WORKING_DIR}}'
    interactive: true
    cmds:
      - |
        # Select env file
        SELECTED_ENV_FILE=$(task env:select)

        echo "Opening $SELECTED_ENV_FILE in SOPS editor..."
        EDITOR="idea --wait" sops --input-type dotenv --output-type dotenv "$SELECTED_ENV_FILE"

  exec:
    desc: Execute command in package with env files (interactive selection)
    label: env:exec
    dir: '{{.ROOT_DIR}}'
    interactive: true
    vars:
      SCOPE: '{{.SCOPE | default ""}}'
      SPINNER_TITLE: '{{.SPINNER_TITLE}}'
      STDERR: '{{.STDERR | default .DEFAULT_STDERR}}'
      STDOUT: '{{.STDOUT | default .DEFAULT_STDOUT}}'
    cmds:
      - |
        # Get list of directories with .env.* files
        ENV_FILES=$(find . -name ".env.*" -type f ! -name ".env" 2>/dev/null)

        if [ -z "$ENV_FILES" ]; then
          task tui:print-error MESSAGES="'[ERROR] .env files not found'"
          exit 1
        fi

        PACKAGES=$(echo "$ENV_FILES" | \
          xargs -I {} dirname {} | \
          sort -u | \
          jq -R -s -c 'split("\n") | map(select(length > 0)) | map({name: ., directory: .})')

        # Call shell:exec task
        task shell:exec \
          PACKAGES="$PACKAGES" \
          SCOPE='{{.SCOPE}}' \
          SPINNER_TITLE='{{.SPINNER_TITLE}}' \
          STDOUT='{{.STDOUT}}' \
          STDERR='{{.STDERR}}' \
          -- {{.CLI_ARGS}}

  select:
    label: env:select
    dir: '{{.USER_WORKING_DIR}}'
    interactive: true
    cmds:
      - |
        # Get all .env.* files
        ENV_FILES=$(ls -1 .env.* 2>/dev/null | grep -v '^\.env$' || true)
        if [ -z "$ENV_FILES" ]; then
          task tui:print-error MESSAGES="'[ERROR] No .env files found in current directory'"
          exit 1
        fi

        # Show selection menu
        task tui:select \
          HEADER="Select environment:" \
          OPTIONS="$ENV_FILES"

  show:
    desc: Show current environment
    dir: '{{.USER_WORKING_DIR}}'
    interactive: true
    vars:
      EXEC: '{{.EXEC | default "true"}}'
      SCOPE: '{{.SCOPE | default ""}}'
    cmds:
      - |
        if [ "{{.EXEC}}" = "true" ]; then
          task env:exec SCOPE='{{.SCOPE}}' -- task env:show EXEC=false
          exit $?
        fi

        if [ -L .env ]; then
          ENV=$(readlink .env)
          echo "Active environment: $ENV"
        else
          task tui:print-error MESSAGES="'[ERROR] Environment not activated' 'Activate environment using task env:use command'"
        fi

  use:
    desc: Switch environment (interactive selection)
    dir: '{{.USER_WORKING_DIR}}'
    interactive: true
    cmds:
      - |
        # Select env file
        SELECTED_ENV_FILE=$(task env:select)

        # Create symlink
        ln -sf "$SELECTED_ENV_FILE" .env

        task tui:print-success MESSAGES="'Environment $SELECTED_ENV_FILE activated'"
